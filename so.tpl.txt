{  
   "Parameters":{
      "LatestAmiId":{
         "Type":"AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
         "Default":"/aws/service/ami-amazon-linux-latest/amzn-ami-hvm-x86_64-ebs"
      },
      "OksoftSG":{
         "Type":"AWS::EC2::SecurityGroup::Id"
      },
      "KeyName":{
         "Type":"AWS::EC2::KeyPair::KeyName"
      },
      "MyInstanceType":{
         "Type":"String",
         "Default":"t2.medium",
         "AllowedValues":[
            "t2.medium",
            "m3.medium",
            "i3.xlarge"
         ]
      }
   },

   "Resources":{  
      "MySpotFleet":{  
         "Type":"AWS::EC2::SpotFleet",
         "Properties":{  
            "SpotFleetRequestConfigData":{  
               "TargetCapacity":1,
              "IamFleetRole":{
                  "Fn::Sub":"arn:aws:iam::${AWS::AccountId}:role/aws-ec2-spot-fleet-tagging-role"
               },
               "LaunchSpecifications":[  
                  {  
                     "ImageId":{
                        "Ref":"LatestAmiId"
                     },
                     "KeyName":{
                        "Ref":"KeyName"
                     },
                     "SecurityGroups":[  
                        {  
                           "GroupId": {"Ref":"OksoftSG"}
                        }
                     ],
                     "InstanceType":{
                        "Ref":"MyInstanceType"
                     },
                     "IamInstanceProfile":{
              "Arn": {
                  "Fn::Sub":"arn:aws:iam::${AWS::AccountId}:instance-profile/my_new_role"
               }},
                     "BlockDeviceMappings":[  
                        {  
                           "DeviceName":"/dev/xvda",
                           "Ebs":{  
                              "DeleteOnTermination":true,
                              "VolumeType":"standard",
                              "VolumeSize":400
                           }
                        }
                     ],
                     "UserData":{  
                        "Fn::Base64":{  
                           "Fn::Join":[  
                              "",
                              [  
                                 "#!/bin/bash -xe\n",
                                 "yum install -y docker mysql git python-pip > /tmp/line1_succ.txt 2> /tmp/line1_err.txt\n",
                                 "service docker start > /tmp/line2_succ.txt 2> /tmp/line2_err.txt \n",
                                 "docker run -d -p 8887:8888 -v /tmp:/tmp shantanuo/notebook > /tmp/line3_succ.txt 2> /tmp/line3_err.txt \n",
                                 "pip install aws-ec2-assign-elastic-ip > /tmp/line4_succ.txt 2> /tmp/line4_err.txt \n ",
                                 "sudo sh -c \"echo ",
                                 {  
                                    "Fn::ImportValue":"secretKey"
                                 },
                                 " >> /home/ec2-user/mysecret.txt\" \n",
                                 "sudo sh -c \"echo ",
                                 {  
                                    "Fn::ImportValue":"accessKey"
                                 },
                                 " >> /home/ec2-user/myaccesskey.txt\" \n",
                                 "/usr/local/bin/aws-ec2-assign-elastic-ip --access-key ''`cat /home/ec2-user/myaccesskey.txt`''  --secret-key ''`cat /home/ec2-user/mysecret.txt`'' --valid-ips 18.210.57.140 > /tmp/line5_succ.txt 2> /tmp/line5_err.txt \n "
                              ]
                           ]
                        }
                     }
                  }
               ]
            }
         }
      }
   }
}
